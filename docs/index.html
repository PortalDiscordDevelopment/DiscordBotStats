<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Charts</title>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="module">
            fetch('https://raw.githubusercontent.com/PortalDiscordDevelopment/MultiBotRunner/main/data/data.json')
                .then((res) => res.json())
                .then((data) => {
                    const latest = data[Object.keys(data)[Object.keys(data).length - 1]];
                    const last1 = data[Object.keys(data)[Object.keys(data).length - 2]];
                    const last2 = data[Object.keys(data)[Object.keys(data).length - 3]];
                    const last3 = data[Object.keys(data)[Object.keys(data).length - 4]];
                    const last4 = data[Object.keys(data)[Object.keys(data).length - 5]];

                    const div = document.getElementById('latest');

                    const total = { users: 0, servers: 0 };
                    Object.values(latest).map((value) => {
                        total.servers += value.guildCount;
                        total.users += value.userCount;
                    });

                    div.innerHTML = `<center>
                        <h1>The latest 5 data updates</h1>
                        <p>The table displays the 5 most recent data updates, the gain column shows the difference between the most recent and the one to last most recent data.</p>
                        <table>
                        <tr class="trHeader">
                            <th>Bot</th><th>${new Date(Number(Object.keys(data).slice(Object.keys(data).length - 5, Object.keys(data).length - 4))).toDateString()}</th><th>${new Date(
                        Number(Object.keys(data).slice(Object.keys(data).length - 4, Object.keys(data).length - 3))
                    ).toDateString()}</th><th>${new Date(Number(Object.keys(data).slice(Object.keys(data).length - 3, Object.keys(data).length - 2))).toDateString()}</th><th>${new Date(
                        Number(Object.keys(data).slice(Object.keys(data).length - 2, Object.keys(data).length - 1))
                    ).toDateString()} (Last)</th><th>${new Date(Number(Object.keys(data).pop())).toDateString()} (Latest)</th><th>Gain (Latest - Last)</th>
                        </tr>
                            ${Object.keys(latest)
                                .map((key) => {
                                    const pre1 = last1[key].guildCount;
                                    const pre2 = last2[key].guildCount;
                                    const pre3 = last3[key].guildCount;
                                    const pre4 = last4[key].guildCount;
                                    const post = latest[key].guildCount;
                                    const dif = post - pre1;

                                    return `<tr class="${key}"><td class="tdName">${key}</td><td>${pre4}</td><td>${pre3}</td><td>${pre2}</td><td>${pre1}</td><td>${post}</td><td class="${
                                        dif >= 0 ? 'gain' : 'loss'
                                    }">${dif}</td></tr>`;
                                })
                                .join('')}
                        </table>
                        <h1>Total Stats</h1>
                        <table>
                            <tr class="trHeader">
                                <th>Bots</th><th>Servers</th><th>Users</th>
                            </tr>   
                            <tr class="trStats">
                                <td>${Object.keys(latest).length}</td><td>${total.servers}</td><td>${total.users}</td>
                            </tr>
                        </table>
                        </center>`;

                    const servers = [['Date']],
                        users = [['Date']],
                        shards = [['Date']];

                    Object.entries(data).map(([timestamp, v]) => {
                        Object.keys(v).map((bot) => {
                            if (!servers.at(0).includes(bot)) servers.at(0).push(bot);
                            if (!users.at(0).includes(bot)) users.at(0).push(bot);
                            if (!shards.at(0).includes(bot)) shards.at(0).push(bot);
                        });

                        servers.push([new Date(Number(timestamp)), ...Object.values(v).map((i) => i.guildCount)]);
                        users.push([new Date(Number(timestamp)), ...Object.values(v).map((i) => i.userCount)]);
                        shards.push([new Date(Number(timestamp)), ...Object.values(v).map((i) => i.shardCount)]);
                    });

                    google.charts.load('current', { packages: ['corechart'] });
                    google.charts.setOnLoadCallback(() => {
                        drawChart('Total Servers', servers);
                        drawChart('Total Users', users);
                        drawChart('Total Shards', shards);
                    });

                    function drawChart(title, table) {
                        const data = google.visualization.arrayToDataTable(table);

                        const options = {
                            title,
                            curveType: 'function',
                            legend: { position: 'bottom' },
                        };

                        const chart = new google.visualization.LineChart(document.getElementById(title.replace(/ +/gim, '')));

                        chart.draw(data, options);
                    }
                });
        </script>

        <style>
            body {
                background: darkslateblue;
                text-align: center;
                font-family: Arial, Helvetica, sans-serif;
            }

            .chart {
                background-color: white;
                border: 2px solid black;
                border-radius: 0.5rem;
                height: 60vh;
                margin: 10px;
                padding: 5px;
            }

            .tdName {
                text-align: left;
            }

            .trHeader {
                background-color: darkslategrey;
                color: white;
            }

            .gain {
                color: greenyellow;
            }

            .loss {
                color: red;
            }

            th {
                padding: 15px;
            }

            td {
                text-align: center;
                padding-left: 10px;
                padding-right: 10px;
            }

            .Amplifier {
                background-color: orangered;
            }

            .ChannelManager {
                background-color: purple;
                color: white;
            }
            .Essence {
                background-color: white;
            }
            .Metamorphosis {
                background-color: lightblue;
            }
            .PortalQuiz {
                background-color: pink;
            }
            .RobloxUtilities {
                background-color: grey;
            }
            .SupercellUtilities {
                background-color: yellow;
            }
            .ToDoListBot {
                background-color: green;
            }
            .YourApps {
                background-color: orange;
            }
            .Zodiac {
                background-color: blue;
                color: white;
            }
        </style>
    </head>
    <body>
        <div class="chart" id="latest"></div>
        <div class="chart" id="TotalServers"></div>
        <div class="chart" id="TotalUsers"></div>
        <div class="chart" id="TotalShards"></div>
    </body>
</html>
